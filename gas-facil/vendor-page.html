<!DOCTYPE html>
<html lang="en">

<head>
	<script type="text/javascript"
			src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript"
			src="http://www.parsecdn.com/js/parse-1.2.19.min.js"></script>
	<script src="js/alertify.js"></script>
	<script type="text/javascript" src="js/orderNotification.js"></script>
	<script type="text/javascript" src="js/ion.sound.min.js"></script>
	<script type="text/javascript" src="js/jquery.ion.sound.min.js"></script>
	<script type="text/javascript" src="js/filepath.js"></script>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<meta name="author" content="">

	<title>Gás Fácil</title>

	<!-- Bootstrap Core CSS -->
	<link href="css/bootstrap.min.css" rel="stylesheet">

	<!-- Custom CSS -->
	<link href="css/thumbnail-gallery.css" rel="stylesheet">
	<link href="css/navbar-custom.css" rel="stylesheet">
	<link rel="stylesheet" href="css/alertify.core.css" />
	<link rel="stylesheet" href="css/alertify.default.css" />
	<link rel="stylesheet" href="css/alertify.bootstrap.css" />

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
	<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->

</head>

<body>
<div class="main">
	<script type="text/javascript">
		function initializeOrders() {
			Parse.initialize("rMJLW7qybdglATi4FowrRFwmVqZkLoxuo6vntg1c", "cvrkyMx0c4X2oG8vI9OkvtjnAClum3K9HMTkCj4i");
			var orders = Parse.Object.extend("Pedido");
			var queryOrders = new Parse.Query(orders);
	
			queryOrders.include("comprador");
			queryOrders.include("produto");
			var buyers = Parse.Object.extend("User");
			queryOrders.addDescending("createdAt");
			
			return queryOrders; 
		}
		
		function fillOrderArray(object, status) {
			order = [];
			
			order.push(object.id);
			order.push(status);
					
			var buyer = object.get('comprador');
			order.push(buyer.get('nome'));
			order.push(buyer.get('endereco'));
					
			var product = object.get('produto');
			order.push(product.get('type'));
			
			order.push(object.get('quantidade'));
			order.push(object.get('price'));
			order.push(object.get('troco'));
			
			return order;
		}
	
		var getPhotos = function() {
			Parse.initialize("rMJLW7qybdglATi4FowrRFwmVqZkLoxuo6vntg1c", "cvrkyMx0c4X2oG8vI9OkvtjnAClum3K9HMTkCj4i");
			var productsImages = Parse.Object.extend("Produto");
			var query = new Parse.Query(productsImages);
			query.find({
				success : function(results) {
					imageURLs = [];
					for (var i = 0; i < results.length; i++) {
						var object = results[i];
						imageURLs.push(object.get('photo').url());
						var index = i + 1;
						$('#Image0' + index).attr('src', imageURLs[i]);
					}

				},
				error : function(error) {
					alert("Error: " + error.code + " " + error.message);
				}
			});
		};

		var deleteOldOrders = function(){
			$("#orders-table tbody").remove();
		}

		var getOrders = function() {
			var queryOrders = initializeOrders();
			
			queryOrders.find({
				success : function(results) {
					orders = [];
					for (var i = 0; i < results.length; i++) {
						var object = results[i];
						order = [];
						
						var status = object.get('status');
						if(status == "Pendente") {
							var order = fillOrderArray(object, status);
							orders.push(order);
						}						
					}

					deleteOldOrders(); //clean the table before adding the elements again (to avoid duplication)

					var table = document.getElementById("orders-table");
					
					var tbody = document.createElement("tbody");
					table.appendChild(tbody);
							
					orders.forEach(function(items) {
						var row = document.createElement("tr");
						var bt_process_order = document.createElement('input'); 
								
						items.forEach(function(item) {
							var cell = document.createElement("td");
							cell.textContent = item;
							
							bt_process_order.setAttribute('type','button'); 
							bt_process_order.setAttribute('class','btn btn-primary');
							bt_process_order.setAttribute('value','Processar');
									
							bt_process_order.onclick = function() {
								queryOrders.equalTo("objectId", items[0]);
								queryOrders.first({
									success: function(object) {
						    			object.set("status", "Enviado");
						   				object.save();
								   		
						   		 		var canDismiss = false;
						   	 			var notification = alertify.success('Pedido processado com sucesso!');
						   	 			notification.ondismiss = function(){ return canDismiss; };
						   	 			setTimeout(function(){ canDismiss = true;}, 20000);
					                    
						   	 			clickOnOrders();
						  			},
						  			error: function(error) {
						    			alert("Error: " + error.code + " " + error.message);
						  			}
								});
				    		}
						    
							row.appendChild(cell);
						});
								
						row.appendChild(bt_process_order);
						tbody.appendChild(row);
					});
				},
				error : function(error) {
					alert("Error: " + error.code + " " + error.message);
				}
			});
		};
		
		var getHistory = function() {
			var queryOrders = initializeOrders();
			
			queryOrders.find({
				success : function(results) {
					orders = [];
					for (var i = 0; i < results.length; i++) {
						var object = results[i];
						order = [];
						
						var status = object.get('status');
						if(status != "Pendente" && status != "pendente" && status != "enviado") {
							var order = fillOrderArray(object, status);
							orders.push(order);
						}						
					}

					deleteOldOrders(); //clean the table before adding the elements again (to avoid duplication)

					var table = document.getElementById("history-table");
					
					var tbody = document.createElement("tbody");
					table.appendChild(tbody);
					orders.forEach(function(items) {
						var row = document.createElement("tr");
						var dd_process_order = document.getElementById("dropdown-order");

						items.forEach(function(item) {
							var cell = document.createElement("td");
							cell.textContent = item;
							
						    row.appendChild(cell);
						});
						
						row.appendChild(dd_process_order);
						tbody.appendChild(row);
					});
				},
				error : function(error) {
					alert("Error: " + error.code + " " + error.message);
				}
			});
		};


		$(document).ready(function() {
			$("#orders-list").hide();
			$("#history-list").hide();
			getPhotos();
			getOrders();
			checkOrders();
			getHistory();
		});
		
		$(document).ready(function() {
			$('img').on('click',function() {
				var src = $(this).attr('src');
				var img = '<img src="' + src + '" class="img-responsive"/>';
				$('#myModal').modal();
				$('#myModal').on('shown.bs.modal', function() {
					$('#myModal .modal-body').html(img);
				});
				$('#myModal').on('hidden.bs.modal',function() {
					$('#myModal .modal-body').html('');
				});
			});
		})
	</script>

	<!-- Navigation -->
	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">
				<button id="dropdown-menu" type="button"
						class="navbar-toggle collapsed" data-toggle="collapse"
						data-target="#bs-example-navbar-collapse-1">
					<span class="sr-only">Toggle navigation</span> <span
						class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
			</div>
			<!-- Collect the nav links, forms, and other content for toggling -->
			<div class="collapse navbar-collapse"
				 id="bs-example-navbar-collapse-1">
				<ul class="nav navbar-nav">
					<li><a id="products-opt" href="#">Produtos</a></li>
					<li><a id="orders-opt" href="#">Pedidos</a></li>
					<li><a id="history-opt" href="#">Histórico</a></li>
					<li><a id="profile-opt" href="#">Perfil</a></li>
				</ul>
				<ul class="nav navbar-nav navbar-right">
					<li><a id="logout" href="index.html">Sair</a></li>
				</ul>
			</div>

			<!-- /.navbar-collapse -->
		</div>
		<!-- /.container -->
		<script type="text/javascript">
			$("#products-opt").click(function() {
				getPhotos();
				$("#products-list").show();
				$("#orders-list").hide();
				$("#history-list").hide();
			});
			$("#orders-opt").click(function() {
				getOrders();
				$("#orders-list").show();
				$("#products-list").hide();
				$("#history-list").hide();
			});
			$("#history-opt").click(function() {
				getHistory();
				$("#history-list").show();
				$("#products-list").hide();
				$("#orders-list").hide();
			});
			$("#profile-opt").click(function() {
				$("#products-list").hide();
				$("#orders-list").hide();
				$("#history-list").show();
			});
			$('#dropdown-menu').change(function() {
				var selected = $(this).find(':selected').val();
				if (selected == 1) {
					getPhotos();
				}
			});
			$("#logout").click(function() {
				Parser.User.logout();
			});
		</script>
	</nav>

	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-body"></div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal-dialog -->
	</div>
	<!-- /.modal -->
	<!-- Page Content -->
	
	<div id="dropdown-order" class="btn-group" style="margin-top:10px;">
  		<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
    	Modificar status <span class="caret"></span></button>
  		
  		<ul class="dropdown-menu" role="menu">
   	 		<li><a href="#">Cancelado - Cliente</a></li>
    		<li><a href="#">Cancelado - Endereço errado</a></li>
    		<li><a href="#">Cancelado - Outro</a></li>
  		</ul>
	</div>

	<div id="products-list" class="container">
		<div class="row">
			<div class="col-lg-12">
				<h1 class="page-header">Produtos</h1>
			</div>
			<div class="col-sm-6 col-md-4">
				<a class="thumbnail" href="#"> <img class="img-responsive"
													id="Image01" src="http://placehold.it/300x300">
				</a>
			</div>
			<div class="col-sm-6 col-md-4">
				<a class="thumbnail" href="#"> <img class="img-responsive"
													id="Image02" src="http://placehold.it/300x300">
				</a>
			</div>
			<div class="col-sm-6 col-md-4">
				<a class="thumbnail" href="#"> <img class="img-responsive"
													id="Image03" src="http://placehold.it/300x300">
				</a>
			</div>
		</div>

		<hr>

		<!-- Footer -->
		<div class="footer" style="text-align: center">
			<small>Copyright © 2014 Gás Fácil</small>
		</div>
	</div>

	<div id="orders-list" class="container">
		<div class="row">
			<div class="col-lg-12">
				<h1 class="page-header">Pedidos</h1>
			</div>

			<div class="container-table">
				<table id="orders-table" class="table table-striped table-hover">
					<thead>
					<tr>
						<th>Id</th>
						<th>Status</th>
						<th>Nome do cliente</th>
						<th>Endereço de entrega</th>
						<th>Produto</th>
						<th>Quantidade</th>
						<th>Valor pago</th>
						<th>Troco</th>
					</tr>
					</thead>
				</table>
			</div>
		</div>
		<!-- /.container -->

		<hr>

		<!-- Footer -->
		<div class="footer" style="text-align: center">
			<small>Copyright © 2014 Gás Fácil</small>
		</div>
	</div>
	
	<div id="history-list" class="container">
		<div class="row">
			<div class="col-lg-12">
				<h1 class="page-header">Histórico</h1>
			</div>

			<div class="container-table">
				<table id="history-table" class="table table-striped table-hover">
					<thead>
					<tr>
						<th>Id</th>
						<th>Status</th>
						<th>Nome do cliente</th>
						<th>Endereço de entrega</th>
						<th>Produto</th>
						<th>Quantidade</th>
						<th>Valor pago</th>
						<th>Troco</th>
					</tr>
					</thead>
				</table>
			</div>
		</div>
		<!-- /.container -->

		<hr>

		<!-- Footer -->
		<div class="footer" style="text-align: center">
			<small>Copyright © 2014 Gás Fácil</small>
		</div>
	</div>

	<!-- jQuery Version 1.11.1 -->
	<script src="js/jquery-1.11.1.min.js"></script>

	<!-- Bootstrap Core JavaScript -->
	<script src="js/bootstrap.min.js">
	</script>
</div>

</body>
</html>
